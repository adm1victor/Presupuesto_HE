<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PRESUPUESTO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Librerías necesarias para PDF y Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin:20px; background:#fff; color:#222; }
    header { display:flex; justify-content:space-between; align-items:flex-start; border-bottom:2px solid #0e62b0; padding-bottom:10px; margin-bottom:16px; }
    .logo-container { width:200px; height:80px; display:flex; justify-content:flex-end; align-items:flex-start; }
    .logo-image { max-width:200px; max-height:80px; object-fit:contain; }
    .company { font-weight:bold; color:#0e62b0; margin-bottom:8px;}
    .currency-selector { margin-top:10px; }
    h1 { text-align:center; color:#0e62b0; margin:16px 0; }
    .cliente-container { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px; }
    .cliente-box, .card { border:1px solid #ccc; border-radius:8px; padding:12px; margin:10px 0; background:#fafafa; }
    .cliente-field label { font-weight:bold; color:#555; margin-bottom:4px; font-size:0.9rem;}
    .cliente-field input { padding:8px; border:1px solid #ccc; border-radius:6px;}
    .actions { margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }
    .editable { border: 1px dashed #ccc; border-radius:6px; padding:6px; min-height:60px;}
    table { width:100%; border-collapse:collapse; margin-top:8px;}
    th, td { border:1px solid #ccc; padding:6px;}
    th { background:#f0f0f0;}
    .right { text-align:right; }
    .btn { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; background:#e9eef6; }
    .btn-primary { background:#0e62b0; color:#fff;}
    .btn-danger { background:#b00020; color:#fff;}
    .btn-success { background:#28a745; color:#fff;}
    .btn-warning { background:#ffc107; color:#000;}
    .export-actions { display:flex; gap:10px; justify-content:center; margin:20px 0;}
    .logo-selector { margin-top:10px; padding:10px; border:1px dashed #ccc; border-radius:6px; background:#f9f9f9;}
    .logo-selector label { font-size:0.9rem; color:#555;}
    .edit-input { width:100%; padding:4px; border:1px solid #0e62b0; border-radius:4px; }
    .discount-container { display:flex; align-items:center; justify-content:flex-end; gap:10px; }
    .iva-container { display:flex; align-items:center; justify-content:flex-end; gap:10px; }
    .modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.4); }
    .modal-content { background-color:#fefefe; margin:15% auto; padding:20px; border:1px solid #888; width:80%; max-width:500px; border-radius:8px; }
    .close { color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer; }
    .close:hover { color:black; }
    .form-group { margin-bottom:15px; }
    .form-group label { display:block; margin-bottom:5px; font-weight:bold; }
    .form-group input, .form-group select { width:100%; padding:8px; border:1px solid #ccc; border-radius:4px; }
    .modal-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:20px; }
  </style>
</head>
<body>

<!-- Notificación -->
<div id="notification" class="notification"></div>

<!-- Modal para edición de ítems -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h2>Editar Ítem</h2>
    <div class="form-group">
      <label for="editCant">Cantidad:</label>
      <input type="number" id="editCant" min="1">
    </div>
    <div class="form-group">
      <label for="editDesc">Descripción:</label>
      <input type="text" id="editDesc">
    </div>
    <div class="form-group">
      <label for="editTipo">Tipo:</label>
      <select id="editTipo">
        <option value="bien">Bien</option>
        <option value="servicio">Servicio</option>
      </select>
    </div>
    <div class="form-group">
      <label for="editUnit">Precio Unitario:</label>
      <input type="number" id="editUnit" step="0.01" min="0">
    </div>
    <div class="modal-actions">
      <button class="btn btn-danger" id="cancelEdit">Cancelar</button>
      <button class="btn btn-primary" id="saveEdit">Guardar</button>
    </div>
  </div>
</div>

<header>
  <div id="companyInfo">
    <div class="company">EMPRESA DEMO S.R.L.</div>
    <div style="font-weight:normal;color:#666;">Servicios y soluciones industriales</div>
  </div>
  <div class="currency-selector">
    <strong>Moneda:</strong>
    <select id="currencySelect">
      <option value="ARS">Pesos Argentinos ARS</option>
      <option value="USD">Dólares USD</option>
    </select>
  </div>
  <div class="logo-selector">
    <label for="logoInput">Logo institucional</label>
    <input type="file" id="logoInput" accept="image/*"/>
    <button class="btn btn-danger" id="removeLogo" style="display:none;">Eliminar logo</button>
  </div>
  <div class="logo-container" id="logoContainer"></div>
</header>

<h1>PRESUPUESTO N° <span id="budgetIdEl">1</span></h1>

<!-- Datos cliente en dos columnas -->
<section class="cliente-container">
  <div class="cliente-box">
    <div class="cliente-field"><label>Razón social</label> <input id="razon" placeholder="Ej. Cliente SRL"></div>
    <div class="cliente-field"><label>CUIT</label> <input id="cuit" placeholder="Ej. 30-12345678-9"></div>
    <div class="cliente-field"><label>Dirección</label> <input id="direccion" placeholder="Ej. Calle 123"></div>
    <div class="cliente-field"><label>Contacto</label> <input id="contacto" placeholder="Ej. Juan Pérez"></div>
  </div>
  <div class="cliente-box">
    <div class="cliente-field"><label>Teléfono</label> <input id="telefono" placeholder="Ej. 54 221 460 0760"></div>
    <div class="cliente-field"><label>Email</label> <input id="mail" placeholder="Ej. client@correo.com"></div>
    <div class="cliente-field"><label>Usuario</label> <input id="usuario" placeholder="Ej. Karina"></div>
    <div class="cliente-field"><label>Fecha</label> <span id="fechaEmitida"></span></div>
  </div>
</section>

<section class="card">
  <h2>Propuesta técnica</h2>
  <div class="editable" id="descArea" contenteditable="true" spellcheck="true">Descripción del servicio, detalles técnicos, etc.</div>
  <div class="editable" id="diagArea" contenteditable="true" spellcheck="true">Diagnóstico, contexto o análisis previo...</div>
  <div class="editable" id="tareasArea" contenteditable="true" spellcheck="true">Tareas previstas, trabajos a realizar...</div>
  <div class="editable" id="notasArea" contenteditable="true" spellcheck="true">Notas, comentarios adicionales...</div>
</section>
<section class="card">
  <h2>Propuesta económica</h2>
  <div class="actions">
    <input id="itemCant" type="number" placeholder="Cant." style="width:60px;">
    <input id="itemDesc" type="text" placeholder="Descripción" style="flex:2;min-width:150px;">
    <select id="itemTipo" style="width:90px;"><option value="bien">Bien</option><option value="servicio">Servicio</option></select>
    <input id="itemUnit" type="number" placeholder="Precio unitario" step="0.01" style="width:100px;">
    <button class="btn btn-primary" id="btnAdd">Agregar</button>
  </div>
  <table>
    <thead>
      <tr><th>Cant.</th><th>Descripción</th><th>Tipo</th><th class="right">Unitario</th><th class="right">Subtotal</th><th>Acciones</th></tr>
    </thead>
    <tbody id="itemsBody"></tbody>
    <tfoot>
      <tr><td colspan="4" class="right">Subtotal</td><td class="right" id="subtotal">0.00</td><td></td></tr>
      <tr>
        <td colspan="4" class="right discount-container">
          Descuento
          <input type="number" id="discountPercent" min="0" max="100" step="0.1" value="0" style="width:60px;">% 
          <button class="btn btn-warning" id="applyDiscount">Aplicar</button>
        </td>
        <td class="right" id="discountAmount">0.00</td>
        <td></td>
      </tr>
      <tr><td colspan="4" class="right">Subtotal con descuento</td><td class="right" id="subtotalWithDiscount">0.00</td><td></td></tr>
      <tr>
        <td colspan="4" class="right iva-container">
          IVA
          <button class="btn btn-primary" id="toggleIva">21%</button>
        </td>
        <td class="right" id="ivaVal">0.00</td>
        <td></td>
      </tr>
      <tr class="total"><td colspan="4" class="right">TOTAL</td><td class="right" id="totalVal">0.00</td><td></td></tr>
    </tfoot>
  </table>
</section>

<section class="card">
  <h2>PLAZOS DE ENTREGA</h2>
  <div class="editable" id="deliveryTerms" contenteditable="true" spellcheck="true">Ej: 15 días hábiles luego de la orden...</div>
</section>
<section class="card">
  <h2>CONDICIÓN DE PAGO</h2>
  <div class="editable" id="paymentTerms" contenteditable="true" spellcheck="true">Ej: transferencia, 50% anticipo, saldo a entrega...</div>
</section>
<section class="card">
  <h2>NOTA</h2>
  <div class="editable" id="notes" contenteditable="true" spellcheck="true">Condiciones, vigencia, etc.</div>
</section>

<div class="export-actions">
  <button class="btn btn-primary" id="exportPDF">Exportar PDF</button>
  <button class="btn btn-success" id="exportExcel">Exportar Excel</button>
  <button class="btn btn-primary" id="sharePDF">Compartir PDF</button>
  <button class="btn btn-success" id="shareExcel">Compartir Excel</button>
  <button class="btn btn-danger" id="closeBudget">Cerrar Presupuesto</button>
  <button class="btn btn-warning" id="restoreBudget" style="display:none;">Recuperar Anterior</button>
</div>

<!-- SCRIPTS PRINCIPALES -->
<script>
let items = [];
let currentCurrency = "ARS";
let logoImageData = null;
let discountPercentage = 0;
let ivaPercentage = 0.21;
let editingIndex = -1;

let budgetId = 1;
let nextBudgetId = 2;
let lastClosedBudget = null;
const budgetIdEl = document.getElementById("budgetIdEl");

function fmt(number, currency) {
  let num = Number(number || 0).toFixed(2);
  return (currency === "USD" ? "U$D " : "$ ") + num;
}

function renderItems() {
  const tbody = document.getElementById("itemsBody");
  tbody.innerHTML = "";
  let subtotal = 0;
  items.forEach((item, idx) => {
    let sub = item.cant * item.unit;
    subtotal += sub;
    let tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${item.cant}</td>
      <td>${item.desc}</td>
      <td>${item.tipo}</td>
      <td class="right">${fmt(item.unit, currentCurrency)}</td>
      <td class="right">${fmt(sub, currentCurrency)}</td>
      <td>
        <button class="btn btn-primary" onclick="editItem(${idx})">Editar</button>
        <button class="btn btn-danger" onclick="delItem(${idx})">Eliminar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  updateTotals(subtotal);
}

function updateTotals(subtotal) {
  document.getElementById("subtotal").textContent = fmt(subtotal, currentCurrency);
  
  let discountAmount = subtotal * (discountPercentage / 100);
  document.getElementById("discountAmount").textContent = fmt(discountAmount, currentCurrency);
  
  let subtotalWithDiscount = subtotal - discountAmount;
  document.getElementById("subtotalWithDiscount").textContent = fmt(subtotalWithDiscount, currentCurrency);
  
  let iva = subtotalWithDiscount * ivaPercentage;
  document.getElementById("ivaVal").textContent = fmt(iva, currentCurrency);
  
  let total = subtotalWithDiscount + iva;
  document.getElementById("totalVal").textContent = fmt(total, currentCurrency);
}

function addItem() {
  let cant = parseInt(document.getElementById("itemCant").value);
  let desc = document.getElementById("itemDesc").value.trim();
  let tipo = document.getElementById("itemTipo").value;
  let unit = parseFloat(document.getElementById("itemUnit").value);
  if (!desc || isNaN(cant) || isNaN(unit) || cant<=0 || unit<=0) {
    alert("Complete todos los campos correctamente.");
    return;
  }
  items.push({cant, desc, tipo, unit});
  renderItems();
  document.getElementById("itemCant").value="";
  document.getElementById("itemDesc").value="";
  document.getElementById("itemUnit").value="";
}

function delItem(idx) {
  if (confirm("¿Eliminar este ítem?")) {
    items.splice(idx,1);
    renderItems();
  }
}

function editItem(idx) {
  editingIndex = idx;
  const item = items[idx];
  document.getElementById("editCant").value = item.cant;
  document.getElementById("editDesc").value = item.desc;
  document.getElementById("editTipo").value = item.tipo;
  document.getElementById("editUnit").value = item.unit;
  document.getElementById("editModal").style.display = "block";
}

// LOGO
document.getElementById("logoInput").addEventListener("change", function(e){
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(evt){
      logoImageData = evt.target.result;
      displayLogo();
    };
    reader.readAsDataURL(file);
  }
});

document.getElementById("removeLogo").addEventListener("click", function() {
  if (confirm("¿Eliminar el logo institucional?")) {
    logoImageData = null;
    document.getElementById("logoContainer").innerHTML="";
    document.getElementById("companyInfo").style.display = "block";
    this.style.display="none";
  }
});

function displayLogo(){
  const cont = document.getElementById("logoContainer");
  cont.innerHTML="";
  if(logoImageData){
    const img = document.createElement("img");
    img.src=logoImageData;
    img.className="logo-image";
    img.alt="Logo Institucional";
    cont.appendChild(img);
    document.getElementById("removeLogo").style.display="inline-block";
    document.getElementById("companyInfo").style.display = "none";
  } else {
    document.getElementById("companyInfo").style.display = "block";
    document.getElementById("removeLogo").style.display = "none";
  }
}

// CURRENCY
document.getElementById("currencySelect").addEventListener("change", function(e) {
  currentCurrency = e.target.value;
  renderItems();
});

// FECHA
function setFecha() {
  document.getElementById("fechaEmitida").textContent = (new Date()).toLocaleDateString("es-AR");
}
setFecha();

// ADD ITEM
document.getElementById("btnAdd").onclick = addItem;

// DISCOUNT
document.getElementById("applyDiscount").onclick = function() {
  discountPercentage = parseFloat(document.getElementById("discountPercent").value) || 0;
  if (discountPercentage < 0) discountPercentage = 0;
  if (discountPercentage > 100) discountPercentage = 100;
  document.getElementById("discountPercent").value = discountPercentage;
  renderItems();
};

// IVA TOGGLE
document.getElementById("toggleIva").onclick = function() {
  if (ivaPercentage === 0.21) {
    ivaPercentage = 0.105;
    this.textContent = "10.5%";
  } else {
    ivaPercentage = 0.21;
    this.textContent = "21%";
  }
  renderItems();
};

// MODAL EDIT
const modal = document.getElementById("editModal");
const span = document.getElementsByClassName("close")[0];
span.onclick = function() { modal.style.display = "none"; }
window.onclick = function(event) { if (event.target == modal) { modal.style.display = "none"; } }
document.getElementById("cancelEdit").onclick = function() { modal.style.display = "none"; };
document.getElementById("saveEdit").onclick = function() {
  const cant = parseInt(document.getElementById("editCant").value);
  const desc = document.getElementById("editDesc").value.trim();
  const tipo = document.getElementById("editTipo").value;
  const unit = parseFloat(document.getElementById("editUnit").value);
  if (!desc || isNaN(cant) || isNaN(unit) || cant<=0 || unit<=0) {
    alert("Complete todos los campos correctamente.");
    return;
  }
  items[editingIndex] = {cant, desc, tipo, unit};
  renderItems();
  modal.style.display = "none";
};

// PDF y Excel
function checkLibraries() {
  if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
    alert("Error: La librería para generar PDF (jsPDF) no se cargó correctamente.");
    return false;
  }
  if (typeof window.XLSX === 'undefined') {
    alert("Error: La librería para generar Excel (XLSX) no se cargó correctamente.");
    return false;
  }
  return true;
}

document.getElementById("exportPDF").onclick = () => { if(checkLibraries() && items.length > 0) generatePDF(); else if(items.length === 0) alert("¡Agrega al menos un ítem para exportar!"); };
document.getElementById("sharePDF").onclick = () => { if(checkLibraries() && items.length > 0) generatePDF(true); else if(items.length === 0) alert("¡Agrega al menos un ítem para compartir!"); };

async function generatePDF(share = false) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "mm", "a4");
  const pageWidth = doc.internal.pageSize.getWidth();
  let y = 20;
  const clientName = document.getElementById("razon").value.trim() || "Cliente";
  const filename = `Presupuesto ${budgetId} - ${clientName}.pdf`.replace(/[/\\?%*:|"<>]/g, '-')

  if(logoImageData){
    try{ doc.addImage(logoImageData, "PNG", pageWidth-60, 10, 50, 25); }catch(e){}
  } else {
    doc.setFontSize(16); doc.setTextColor(14, 98, 176); doc.text("EMPRESA DEMO S.R.L.", 20, y);
    doc.setFontSize(10); doc.setTextColor(100, 100, 100); doc.text("Servicios y soluciones industriales", 20, y+5);
    y += 10;
  }
  
  doc.setFontSize(24); doc.setTextColor(14, 98, 176); doc.text(`PRESUPUESTO N° ${budgetId}`, 20, y);
  y+=10;

  doc.setFontSize(10); doc.setTextColor(0,0,0);
  doc.text("Fecha: " + document.getElementById("fechaEmitida").textContent, 20, y); y+=7;
  doc.text("Razón social: " + document.getElementById("razon").value, 20, y);
  doc.text("CUIT: " + document.getElementById("cuit").value, 100, y); y+=7;
  doc.text("Dirección: " + document.getElementById("direccion").value, 20, y);
  doc.text("Contacto: " + document.getElementById("contacto").value, 100, y); y+=7;
  doc.text("Teléfono: " + document.getElementById("telefono").value, 20, y);
  doc.text("Email: " + document.getElementById("mail").value, 100, y); y+=7;
  doc.text("Usuario: " + document.getElementById("usuario").value, 20, y);

  y+=14;
  doc.setFontSize(13); doc.setTextColor(14, 98, 176); doc.text("PROPUESTA TÉCNICA", 20, y); y+=7;
  doc.setFontSize(10); doc.setTextColor(0,0,0);
  
  const splitText = (text, maxWidth) => doc.splitTextToSize(text, maxWidth);
  const addTextField = (label, elementId, currentY) => {
    const text = document.getElementById(elementId).innerText;
    const lines = splitText(`${label}: ${text}`, 170);
    lines.forEach(line => { doc.text(line, 20, currentY); currentY += 5; });
    return currentY;
  };
  y = addTextField("Descripción", "descArea", y);
  y = addTextField("Diagnóstico", "diagArea", y);
  y = addTextField("Tareas", "tareasArea", y);
  y = addTextField("Notas", "notasArea", y);
  
  y += 10;
  doc.setFontSize(13); doc.setTextColor(14, 98, 176); doc.text("PROPUESTA ECONÓMICA", 20, y); y+=2;
  
  doc.autoTable({
    head:[["Cant.","Descripción","Tipo","Unitario","Subtotal"]],
    body: items.map(it=>[it.cant, it.desc, it.tipo, fmt(it.unit, currentCurrency), fmt(it.cant*it.unit, currentCurrency)]),
    startY: y+4, margin:{left:20, right:20}, styles:{fontSize:9, cellPadding:2}, theme:"grid",
    headStyles:{fillColor:[232,244,255],textColor:[14,98,176]},
    columnStyles:{0:{halign:'center'},3:{halign:'right'},4:{halign:'right'}}
  });
  let f = doc.lastAutoTable.finalY || (y+30);

  doc.setFontSize(11); doc.setTextColor(0,0,0);
  let subtotal = items.reduce((a, b) => a + b.cant * b.unit, 0);
  let discountAmount = subtotal * (discountPercentage / 100);
  let subtotalWithDiscount = subtotal - discountAmount;
  let iva = subtotalWithDiscount * ivaPercentage;
  let total = subtotalWithDiscount + iva;
  
  doc.text(`Subtotal: ${fmt(subtotal, currentCurrency)}`, 120, f+10);
  doc.text(`Descuento (${discountPercentage}%): ${fmt(discountAmount, currentCurrency)}`, 120, f+16);
  doc.text(`Subtotal con descuento: ${fmt(subtotalWithDiscount, currentCurrency)}`, 120, f+22);
  doc.text(`IVA (${(ivaPercentage*100).toFixed(1)}%): ${fmt(iva, currentCurrency)}`, 120, f+28);
  doc.setFontSize(12); doc.setTextColor(14, 98, 176); doc.text(`TOTAL: ${fmt(total, currentCurrency)}`, 120, f+34);

  f+=40;
  const addSection = (title, elementId, currentY) => {
    doc.setFontSize(12); doc.setTextColor(14, 98, 176); doc.text(title, 20, currentY);
    doc.setFontSize(10); doc.setTextColor(0,0,0);
    const lines = splitText(document.getElementById(elementId).innerText, 170);
    lines.forEach(line => { doc.text(line, 20, currentY+6); currentY += 5; });
    return currentY + 12;
  };
  f = addSection("PLAZOS DE ENTREGA", "deliveryTerms", f);
  f = addSection("CONDICIÓN DE PAGO", "paymentTerms", f);
  addSection("NOTAS ADICIONALES", "notes", f);

  if (share) {
    try {
      const pdfBlob = doc.output('blob');
      const file = new File([pdfBlob], filename, { type: 'application/pdf' });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({ files: [file], title: `Presupuesto ${budgetId}`, text: 'Adjunto presupuesto' });
        return;
      }
      window.open(URL.createObjectURL(pdfBlob), '_blank');
    } catch (err) {
      console.error('Error share PDF:', err);
      doc.save(filename);
    }
  } else {
    doc.save(filename);
  }
}

document.getElementById("exportExcel").onclick = () => { if(checkLibraries() && items.length > 0) generateExcel(); else if(items.length === 0) alert("¡Agrega al menos un ítem para exportar!"); };
document.getElementById("shareExcel").onclick = () => { if(checkLibraries() && items.length > 0) generateExcel(true); else if(items.length === 0) alert("¡Agrega al menos un ítem para compartir!"); };

async function generateExcel(share = false) {
  const wb = XLSX.utils.book_new();
  const clientName = document.getElementById("razon").value.trim() || "Cliente";
  const filename = `Presupuesto ${budgetId} - ${clientName}.xlsx`.replace(/[/\\?%*:|"<>]/g, '-')
  
  const clientData = [
    ["Presupuesto N°", budgetId], ["Razón social", document.getElementById("razon").value], ["CUIT", document.getElementById("cuit").value],
    ["Dirección", document.getElementById("direccion").value], ["Contacto", document.getElementById("contacto").value],
    ["Teléfono", document.getElementById("telefono").value], ["Email", document.getElementById("mail").value],
    ["Usuario", document.getElementById("usuario").value], ["Fecha", document.getElementById("fechaEmitida").textContent]
  ];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(clientData), "Datos del Cliente");
  
  const itemsData = [["Cantidad", "Descripción", "Tipo", "Precio Unitario", "Subtotal"]];
  let subtotal = 0;
  items.forEach(item => { const sub = item.cant * item.unit; subtotal += sub; itemsData.push([item.cant, item.desc, item.tipo, item.unit, sub]); });
  const discountAmount = subtotal * (discountPercentage / 100);
  const subtotalWithDiscount = subtotal - discountAmount;
  const iva = subtotalWithDiscount * ivaPercentage;
  const total = subtotalWithDiscount + iva;
  itemsData.push([], ["Subtotal", "", "", "", subtotal], ["Descuento", `${discountPercentage}%`, "", "", discountAmount],
    ["Subtotal con descuento", "", "", "", subtotalWithDiscount], ["IVA", `${(ivaPercentage*100).toFixed(1)}%`, "", "", iva], ["TOTAL", "", "", "", total]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(itemsData), "Propuesta Económica");
  
  const technicalData = [
    ["Descripción", document.getElementById("descArea").innerText], ["Diagnóstico", document.getElementById("diagArea").innerText],
    ["Tareas", document.getElementById("tareasArea").innerText], ["Notas", document.getElementById("notasArea").innerText]
  ];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(technicalData), "Propuesta Técnica");
  
  const additionalData = [
    ["Plazos de Entrega", document.getElementById("deliveryTerms").innerText], ["Condición de Pago", document.getElementById("paymentTerms").innerText],
    ["Notas Adicionales", document.getElementById("notes").innerText]
  ];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(additionalData), "Información Adicional");
  
  if (share) {
    try {
      const excelBuffer = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      const excelBlob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const file = new File([excelBlob], filename, { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({ files: [file], title: `Presupuesto ${budgetId}`, text: 'Adjunto presupuesto (Excel)' });
        return;
      }
      window.open(URL.createObjectURL(excelBlob), '_blank');
    } catch (err) {
      console.error('Error share Excel:', err);
      XLSX.writeFile(wb, filename);
    }
  } else {
    XLSX.writeFile(wb, filename);
  }
}

function saveState() {
    return {
        id: budgetId,
        items: JSON.parse(JSON.stringify(items)),
        currency: currentCurrency,
        logo: logoImageData,
        discount: discountPercentage,
        iva: ivaPercentage,
        client: {
            razon: document.getElementById("razon").value,
            cuit: document.getElementById("cuit").value,
            direccion: document.getElementById("direccion").value,
            contacto: document.getElementById("contacto").value,
            telefono: document.getElementById("telefono").value,
            mail: document.getElementById("mail").value,
            usuario: document.getElementById("usuario").value,
        },
        sections: {
            desc: document.getElementById("descArea").innerHTML,
            diag: document.getElementById("diagArea").innerHTML,
            tareas: document.getElementById("tareasArea").innerHTML,
            notas: document.getElementById("notasArea").innerHTML,
            delivery: document.getElementById("deliveryTerms").innerHTML,
            payment: document.getElementById("paymentTerms").innerHTML,
            notes: document.getElementById("notes").innerHTML,
        }
    };
}

function loadState(state) {
    budgetId = state.id;
    budgetIdEl.textContent = budgetId;
    items = JSON.parse(JSON.stringify(state.items));
    currentCurrency = state.currency;
    document.getElementById("currencySelect").value = currentCurrency;
    logoImageData = state.logo;
    displayLogo();
    discountPercentage = state.discount;
    document.getElementById("discountPercent").value = discountPercentage;
    ivaPercentage = state.iva;
    document.getElementById("toggleIva").textContent = ivaPercentage === 0.21 ? "21%" : "10.5%";

    document.getElementById("razon").value = state.client.razon;
    document.getElementById("cuit").value = state.client.cuit;
    document.getElementById("direccion").value = state.client.direccion;
    document.getElementById("contacto").value = state.client.contacto;
    document.getElementById("telefono").value = state.client.telefono;
    document.getElementById("mail").value = state.client.mail;
    document.getElementById("usuario").value = state.client.usuario;

    document.getElementById("descArea").innerHTML = state.sections.desc;
    document.getElementById("diagArea").innerHTML = state.sections.diag;
    document.getElementById("tareasArea").innerHTML = state.sections.tareas;
    document.getElementById("notasArea").innerHTML = state.sections.notas;
    document.getElementById("deliveryTerms").innerHTML = state.sections.delivery;
    document.getElementById("paymentTerms").innerHTML = state.sections.payment;
    document.getElementById("notes").innerHTML = state.sections.notes;

    renderItems();
}

function resetForm() {
    items = [];
    editingIndex = -1;
    document.getElementById("razon").value = "";
    document.getElementById("cuit").value = "";
    document.getElementById("direccion").value = "";
    document.getElementById("contacto").value = "";
    document.getElementById("telefono").value = "";
    document.getElementById("mail").value = "";
    document.getElementById("usuario").value = "";
    document.getElementById("descArea").innerHTML = "Descripción del servicio, detalles técnicos, etc.";
    document.getElementById("diagArea").innerHTML = "Diagnóstico, contexto o análisis previo...";
    document.getElementById("tareasArea").innerHTML = "Tareas previstas, trabajos a realizar...";
    document.getElementById("notasArea").innerHTML = "Notas, comentarios adicionales...";
    document.getElementById("deliveryTerms").innerHTML = "Ej: 15 días hábiles luego de la orden...";
    document.getElementById("paymentTerms").innerHTML = "Ej: transferencia, 50% anticipo, saldo a entrega...";
    document.getElementById("notes").innerHTML = "Condiciones, vigencia, etc.";
    document.getElementById("itemCant").value = "";
    document.getElementById("itemDesc").value = "";
    document.getElementById("itemUnit").value = "";
    document.getElementById("discountPercent").value = 0;
    discountPercentage = 0;
    document.getElementById("logoInput").value = "";
    logoImageData = null;
    displayLogo();
    renderItems();
    setFecha();
}

document.getElementById("closeBudget").addEventListener("click", function() {
    if (confirm("¿Está seguro de que desea cerrar este presupuesto y comenzar uno nuevo?")) {
        lastClosedBudget = saveState();
        document.getElementById("restoreBudget").style.display = "inline-block";
        
        resetForm();
        
        budgetId = nextBudgetId;
        nextBudgetId++;
        budgetIdEl.textContent = budgetId;
        
        alert("Presupuesto cerrado. Puede comenzar el nuevo presupuesto N° " + budgetId);
    }
});

document.getElementById("restoreBudget").addEventListener("click", function() {
    if (lastClosedBudget && confirm("¿Desea recuperar el presupuesto anterior? Se perderán los datos no guardados del presupuesto actual.")) {
        loadState(lastClosedBudget);
    }
});

</script>
</body>
</html>
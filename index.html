<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PRESUPUESTO</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:20px;background:#fff;color:#222;}
  header{display:flex;justify-content:flex-end;align-items:flex-start;border-bottom:2px solid #0e62b0;padding-bottom:10px;margin-bottom:16px;}
  .company{font-weight:bold;color:#0e62b0;margin-bottom:15px;}
  .company div:first-child{font-size:1.4rem;}
  .doc-meta{text-align:right;}
  .doc-meta .line{margin:2px 0;}
  h1{text-align:center;color:#0e62b0;margin:16px 0;}
  .card{border:1px solid #ccc;border-radius:8px;padding:12px;margin:10px 0;background:#fafafa;}
  .card h2{margin:0 0 8px;color:#0e62b0;font-size:1.05rem;}
  label{display:block;font-size:0.9rem;color:#555;margin-bottom:2px;}
  input,select,textarea{width:100%;padding:6px;border:1px solid #ccc;border-radius:6px;margin-bottom:4px;}
  textarea{min-height:60px;}
  table{width:100%;border-collapse:collapse;margin-top:8px;}
  th,td{border:1px solid #ccc;padding:6px;}
  th{background:#f0f0f0;}
  tfoot td{font-weight:bold;}
  tfoot tr.total td{background:#e8f4ff;font-size:1.05rem;}
  .right{text-align:right;}
  .btn{padding:6px 12px;border:none;border-radius:6px;cursor:pointer;margin:2px;background:#e9eef6;}
  .btn-primary{background:#0e62b0;color:#fff;}
  .btn-danger{background:#b00020;color:#fff;}
  .btn-success{background:#28a745;color:#fff;}
  .btn:hover{opacity:0.95;}
  .actions{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;}
  .cliente-box{border:1px solid #ccc;border-radius:6px;padding:8px;margin-bottom:10px;line-height:1.2;}
  .editable{border:1px dashed #ccc;border-radius:6px;padding:6px;min-height:60px;}
  .section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;}
  .small-actions{display:flex;gap:6px;align-items:center;}
  .budget-number{font-size:1.2rem;font-weight:bold;color:#0e62b0;text-align:center;margin:20px 0;padding:10px;background:#f8f9fa;border-radius:6px;}
  .export-actions{display:flex;gap:10px;justify-content:center;margin:20px 0;flex-wrap:wrap;}
  
  /* Mejoras de diseño */
  .notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 20px;
    background-color: #4CAF50;
    color: white;
    border-radius: 5px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
    max-width: 300px;
  }
  
  .notification.show {
    opacity: 1;
  }
  
  .notification.error {
    background-color: #f44336;
  }
  
  .notification.warning {
    background-color: #ff9800;
  }
  
  /* Selector de moneda */
  .currency-selector {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 10px;
  }
  
  .currency-selector select {
    width: auto;
    padding: 6px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    background-color: #fff;
    cursor: pointer;
  }
  
  /* Responsive improvements */
  @media (max-width: 768px) {
    header {
      flex-direction: column;
      align-items: center;
      text-align: center;
    }
    
    .doc-meta {
      margin-top: 10px;
      text-align: center;
    }
    
    .actions {
      flex-direction: column;
    }
    
    .actions input, .actions select, .actions button {
      width: 100%;
    }
    
    table {
      font-size: 0.8rem;
    }
    
    th, td {
      padding: 4px;
    }
    
    .export-actions {
      flex-direction: column;
    }
    
    .currency-selector {
      justify-content: center;
    }
  }
</style>
</head>
<body>
<!-- Notificaciones -->
<div id="notification" class="notification"></div>

<header>
  <div class="doc-meta">
    <div class="line"><strong>Presupuesto:</strong> <span id="budgetId">#001</span></div>
    <div class="line"><strong>Fecha:</strong> <span id="fechaEmitida">—</span></div>
    <div class="line"><strong>Usuario:</strong> <span id="userDisplay">—</span></div>
    <div class="currency-selector">
      <strong>Moneda:</strong>
      <select id="currencySelect">
        <option value="ARS">Pesos Argentinos (ARS)</option>
        <option value="USD">Dólares (USD)</option>
      </select>
    </div>
    <!-- NUEVO: Input para imagen institucional -->
    <div class="line" style="margin-top: 10px;">
      <label for="logoInput" style="display: inline; font-size: 0.9rem; color: #555;">Imagen Institucional:</label>
      <input type="file" id="logoInput" accept="image/*" style="width: auto; padding: 4px; margin-left: 10px;">
    </div>
  </div>
</header>

<h1>PRESUPUESTO</h1>

<!-- Datos cliente estilo factura -->
<section class="cliente-box">
  <div class="company">
    <div>HIDRÁULICA ENSENADA</div>
    <div style="font-weight:normal;color:#666;">Conexiones Hidráulicas y Neumáticas</div>
  </div>
  
  <h2>Datos del cliente</h2>
  <label>Razón social</label><input id="razon" placeholder="Ej.: Cliente SRL">
  <label>CUIT</label><input id="cuit" placeholder="Ej.: 30-12345678-9">
  <label>Dirección</label><input id="direccion" placeholder="Ej.: Almafuerte 386, Ensenada">
  <label>Contacto</label><input id="contacto" placeholder="Ej.: Juan Pérez">
  <label>Teléfono</label><input id="telefono" placeholder="Ej.: +54 221 460 0760">
  <label>Email</label><input id="mail" placeholder="Ej.: cliente@correo.com">
  <label>Usuario (editable)</label><input id="usuario" placeholder="Ej.: Karina">
  <button class="btn" id="aplicarUsuario">Aplicar usuario</button>
</section>

<section class="card">
  <h2>Propuesta técnica</h2>
  <div class="actions">
    <button class="btn" data-toggle="desc">Descripción</button>
    <button class="btn" data-toggle="diag">Diagnóstico</button>
    <button class="btn" data-toggle="tareas">Tareas</button>
    <button class="btn" data-toggle="notas">Notas</button>
  </div>

  <div id="descBox" style="display:none;">
    <div class="section-title">
      <label>Descripción</label>
      <div class="small-actions">
        <button class="btn" data-clear="descArea">Borrar texto</button>
      </div>
    </div>
    <div id="descArea" class="editable" contenteditable="true" spellcheck="true"></div>
  </div>

  <div id="diagBox" style="display:none;">
    <div class="section-title">
      <label>Diagnóstico</label>
      <div class="small-actions">
        <button class="btn" data-clear="diagArea">Borrar texto</button>
      </div>
    </div>
    <div id="diagArea" class="editable" contenteditable="true" spellcheck="true"></div>
  </div>

  <div id="tareasBox" style="display:none;">
    <div class="section-title">
      <label>Tareas</label>
      <div class="small-actions">
        <button class="btn" data-clear="tareasArea">Borrar texto</button>
      </div>
    </div>
    <div id="tareasArea" class="editable" contenteditable="true" spellcheck="true"></div>
  </div>

  <div id="notasBox" style="display:none;">
    <div class="section-title">
      <label>Notas</label>
      <div class="small-actions">
        <button class="btn" data-clear="notasArea">Borrar texto</button>
      </div>
    </div>
    <div id="notasArea" class="editable" contenteditable="true" spellcheck="true"></div>
  </div>
</section>

<section class="card">
  <h2>Propuesta económica</h2>
  <div class="actions">
    <input id="itemCant" type="number" placeholder="Cant." style="width:60px;">
    <input id="itemDesc" type="text" placeholder="Descripción" style="flex:2;min-width:250px;" list="itemSuggestions">
    <select id="itemTipo" style="width:90px;">
      <option value="bien">Bien</option>
      <option value="servicio">Servicio</option>
    </select>
    <input id="itemUnit" type="number" placeholder="Precio unitario" step="0.01" style="width:100px;">
    <button class="btn btn-primary" id="btnAdd">Agregar</button>
  </div>
  
  <!-- Lista de sugerencias para autocompletar -->
  <datalist id="itemSuggestions"></datalist>

  <table>
    <thead>
      <tr><th>Cant.</th><th>Descripción</th><th>Tipo</th><th class="right">Unitario</th><th class="right">Subtotal</th><th>Acciones</th></tr>
    </thead>
    <tbody id="itemsBody"></tbody>
    <tfoot>
      <tr><td colspan="4" class="right">Subtotal</td><td id="subtotal" class="right">$0.00</td><td></td></tr>
      <tr><td colspan="4" class="right">Prenda</td><td id="prendaVal" class="right">$0.00</td><td>(fija en 0)</td></tr>
      <tr>
        <td colspan="4" class="right">Descuento / Bonificación</td>
        <td id="descVal" class="right">$0.00</td>
        <td>
          <input id="descPct" type="number" placeholder="% desc" step="0.01" style="width:100px;">
          <button class="btn" id="applyDesc">Aplicar</button>
        </td>
      </tr>
      <tr>
        <td colspan="4" class="right">IVA</td>
        <td id="ivaVal" class="right">$0.00</td>
        <td>
          <select id="ivaSelect" style="width:100px;">
            <option value="21">21%</option>
            <option value="10.5">10.5%</option>
          </select>
          <span id="ivaPctView" style="margin-left:6px;color:#555;">(21%)</span>
        </td>
      </tr>
      <tr class="total"><td colspan="4" class="right">TOTAL</td><td id="totalVal" class="right">$0.00</td><td></td></tr>
    </tfoot>
  </table>
</section>

<!-- Número de presupuesto en texto -->
<div class="budget-number">
  Presupuesto N° <span id="budgetNumberText">001</span> - Total: <span id="budgetTotalText">$0.00</span>
</div>

<!-- Nuevos apartados editables -->
<section class="card">
  <h2>PLAZOS DE ENTREGA</h2>
  <div class="section-title">
    <label>Plazos de entrega</label>
    <div class="small-actions">
      <button class="btn" data-clear="deliveryTerms">Borrar texto</button>
    </div>
  </div>
  <div id="deliveryTerms" class="editable" contenteditable="true" spellcheck="true"></div>
</section>

<section class="card">
  <h2>CONDICIÓN DE PAGO</h2>
  <div class="section-title">
    <label>Condición de pago</label>
    <div class="small-actions">
      <button class="btn" data-clear="paymentTerms">Borrar texto</button>
    </div>
  </div>
  <div id="paymentTerms" class="editable" contenteditable="true" spellcheck="true"></div>
</section>

<section class="card">
  <h2>NOTA</h2>
  <div class="section-title">
    <label>Notas adicionales</label>
    <div class="small-actions">
      <button class="btn" data-clear="notes">Borrar texto</button>
    </div>
  </div>
  <div id="notes" class="editable" contenteditable="true" spellcheck="true"></div>
</section>

<!-- Acciones finales -->
<div class="export-actions">
  <button class="btn btn-success" id="closeBudget">Cerrar Presupuesto</button>
  <button class="btn btn-primary" id="exportExcel">Exportar Excel</button>
  <button class="btn btn-primary" id="exportPDF">Exportar PDF</button>
  <button class="btn btn-primary" id="shareWhatsApp">Compartir WhatsApp</button>
  <button class="btn btn-primary" id="viewBudgets">Ver Presupuestos Guardados</button>
</div>

<!-- Modal para ver presupuestos guardados -->
<div id="budgetsModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; overflow:auto;">
  <div style="background:white; margin:50px auto; padding:20px; width:90%; max-width:800px; border-radius:8px; position:relative;">
    <span id="closeModal" style="position:absolute; top:10px; right:15px; font-size:24px; cursor:pointer;">&times;</span>
    <h2>Presupuestos Guardados</h2>
    <div id="budgetsList"></div>
  </div>
</div>

<script>
  // Utilidades
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  
  // Función de formateo con moneda
  const fmt = (n, currency) => {
    const num = Number(n || 0).toFixed(2);
    return currency === 'USD' ? `U$D ${num}` : `$ ${num}`;
  };
  
  const parseNum = v => { 
    const n = Number(String(v).replace(',','.').replace(/\$|U\$D/g, '').trim()); 
    return isNaN(n) ? 0 : n; 
  };

  // Sistema de notificaciones
  function showNotification(message, type = 'success') {
    const notification = $('#notification');
    notification.textContent = message;
    notification.className = 'notification show';
    
    if (type === 'error') {
      notification.classList.add('error');
    } else if (type === 'warning') {
      notification.classList.add('warning');
    }
    
    setTimeout(() => {
      notification.classList.remove('show');
    }, 3000);
  }

  // Verificar localStorage
  function checkLocalStorage() {
    try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
        return true;
    } catch(e) {
        showNotification('Error: El navegador no permite almacenamiento local. Algunas funciones no estarán disponibles.', 'error');
        return false;
    }
  }

  // Función para descargar archivos
  function downloadFile(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    
    if (navigator.msSaveBlob) {
        navigator.msSaveBlob(blob, filename);
    } else {
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        setTimeout(() => URL.revokeObjectURL(url), 100);
    }
  }

  // Estado
  let items = [];      // {cant, desc, tipo, unit}
  let descPct = 0;     // descuento porcentaje
  let ivaPct = 21;     // IVA seleccionado
  let currentBudgetNumber = 1;
  let savedBudgets = [];
  let itemHistory = [];
  let currentCurrency = 'ARS'; // Moneda actual
  let localStorageAvailable = checkLocalStorage();
  
  // NUEVO: Variable para almacenar la imagen institucional
  let logoImage = null;

  // Cargar datos desde localStorage si está disponible
  if (localStorageAvailable) {
    savedBudgets = JSON.parse(localStorage.getItem('savedBudgets') || '[]');
    itemHistory = JSON.parse(localStorage.getItem('itemHistory') || '[]');
    
    // Cargar moneda guardada
    const savedCurrency = localStorage.getItem('currency');
    if (savedCurrency && ['ARS', 'USD'].includes(savedCurrency)) {
      currentCurrency = savedCurrency;
      $('#currencySelect').value = currentCurrency;
    }
  }

  // Fecha clara
  function setFechaEmitida(){
    $('#fechaEmitida').textContent = new Date().toLocaleDateString('es-AR');
  }

  // ID (simple para demo, con incremento al guardar si luego agregas persistencia)
  function setBudgetId(n){ 
    currentBudgetNumber = n;
    $('#budgetId').textContent = '#' + String(n).padStart(3,'0');
    $('#budgetNumberText').textContent = String(n).padStart(3,'0');
  }
  setBudgetId(1);

  // Cambio de moneda
  $('#currencySelect').addEventListener('change', (e) => {
    currentCurrency = e.target.value;
    
    // Guardar en localStorage
    if (localStorageAvailable) {
      localStorage.setItem('currency', currentCurrency);
    }
    
    // Actualizar todos los montos mostrados
    renderItems();
    computeTotals();
    
    showNotification(`Moneda cambiada a ${currentCurrency === 'ARS' ? 'Pesos Argentinos' : 'Dólares Estadounidenses'}`);
  });

  // Usuario editable
  function aplicarUsuario(){ $('#userDisplay').textContent = $('#usuario').value.trim() || '—'; }
  $('#aplicarUsuario').addEventListener('click', aplicarUsuario);
  $('#usuario').addEventListener('input', aplicarUsuario);

  // Propuesta técnica: toggles y borrar texto
  const toggleMap = { desc: '#descBox', diag: '#diagBox', tareas: '#tareasBox', notas: '#notasBox' };
  $$('.actions [data-toggle]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.getAttribute('data-toggle');
      const box = document.querySelector(toggleMap[key]);
      box.style.display = (box.style.display === 'none' || box.style.display === '') ? 'block' : 'none';
    });
  });
  $$('.small-actions [data-clear]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-clear');
      const area = document.getElementById(id);
      if (area) area.innerHTML = '';
    });
  });

  // Actualizar lista de sugerencias
  function updateItemSuggestions() {
    if (!localStorageAvailable) return;
    
    const datalist = $('#itemSuggestions');
    datalist.innerHTML = '';
    
    // Obtener descripciones únicas
    const uniqueDescriptions = [...new Set(itemHistory.map(item => item.desc))];
    
    uniqueDescriptions.forEach(desc => {
      const option = document.createElement('option');
      option.value = desc;
      datalist.appendChild(option);
    });
  }

  // Propuesta económica
  function renderItems(){
    const tbody = $('#itemsBody'); tbody.innerHTML = '';
    let subtotal = 0;
    items.forEach((it, idx)=>{
      const sub = it.cant * it.unit; subtotal += sub;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.cant}</td>
        <td>${it.desc}</td>
        <td>${it.tipo}</td>
        <td class="right">${fmt(it.unit, currentCurrency)}</td>
        <td class="right">${fmt(sub, currentCurrency)}</td>
        <td>
          <button class="btn" data-edit="${idx}">Editar</button>
          <button class="btn btn-danger" data-del="${idx}">Eliminar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    $('#subtotal').textContent = fmt(subtotal, currentCurrency);
    computeTotals();
  }

  function addItem(){
    const cant = parseInt($('#itemCant').value, 10);
    const desc = $('#itemDesc').value.trim();
    const tipo = $('#itemTipo').value;
    const unit = parseNum($('#itemUnit').value);
    if (!desc || !['bien','servicio'].includes(tipo) || isNaN(cant) || cant<=0 || unit<=0){
      showNotification('Completa Cantidad, Descripción, Tipo y Unitario válidos.', 'error');
      return;
    }
    items.push({ cant, desc, tipo, unit });
    
    // Agregar al historial de ítems
    if (localStorageAvailable) {
      const existingIndex = itemHistory.findIndex(item => item.desc === desc && item.tipo === tipo);
      if (existingIndex >= 0) {
        itemHistory[existingIndex] = { cant, desc, tipo, unit };
      } else {
        itemHistory.push({ cant, desc, tipo, unit });
      }
      localStorage.setItem('itemHistory', JSON.stringify(itemHistory));
      updateItemSuggestions();
    }
    
    // limpiar inputs
    $('#itemCant').value=''; $('#itemDesc').value=''; $('#itemUnit').value='';
    renderItems();
    showNotification('Ítem agregado correctamente');
  }
  $('#btnAdd').addEventListener('click', addItem);

  // Acciones editar/eliminar
  $('#itemsBody').addEventListener('click', (e)=>{
    const edit = e.target.getAttribute('data-edit');
    const del = e.target.getAttribute('data-del');
    if (edit !== null){
      const i = Number(edit); 
      const it = items[i];
      
      // Crear formulario de edición
      const editForm = document.createElement('div');
      editForm.className = 'card';
      editForm.style.position = 'fixed';
      editForm.style.top = '50%';
      editForm.style.left = '50%';
      editForm.style.transform = 'translate(-50%, -50%)';
      editForm.style.zIndex = '1000';
      editForm.style.width = '90%';
      editForm.style.maxWidth = '500px';
      editForm.innerHTML = `
        <h2>Editar Ítem</h2>
        <label>Cantidad</label>
        <input type="number" id="editCant" value="${it.cant}" min="1">
        <label>Descripción</label>
        <input type="text" id="editDesc" value="${it.desc}">
        <label>Tipo</label>
        <select id="editTipo">
          <option value="bien" ${it.tipo === 'bien' ? 'selected' : ''}>Bien</option>
          <option value="servicio" ${it.tipo === 'servicio' ? 'selected' : ''}>Servicio</option>
        </select>
        <label>Precio Unitario (${currentCurrency})</label>
        <input type="number" id="editUnit" value="${it.unit}" step="0.01" min="0">
        <div class="actions">
          <button class="btn btn-primary" id="saveEdit">Guardar</button>
          <button class="btn" id="cancelEdit">Cancelar</button>
        </div>
      `;
      
      document.body.appendChild(editForm);
      
      // Eventos del formulario
      $('#saveEdit').addEventListener('click', () => {
        const cant = parseInt($('#editCant').value, 10);
        const desc = $('#editDesc').value.trim();
        const tipo = $('#editTipo').value;
        const unit = parseNum($('#editUnit').value);
        
        if (!desc || !['bien','servicio'].includes(tipo) || isNaN(cant) || cant<=0 || unit<=0){ 
          showNotification('Valores inválidos.', 'error'); 
          return; 
        }
        
        items[i] = { cant, desc: desc.trim(), tipo, unit };
        
        // Actualizar historial
        if (localStorageAvailable) {
          const existingIndex = itemHistory.findIndex(item => item.desc === desc && item.tipo === tipo);
          if (existingIndex >= 0) {
            itemHistory[existingIndex] = { cant, desc, tipo, unit };
          } else {
            itemHistory.push({ cant, desc, tipo, unit });
          }
          localStorage.setItem('itemHistory', JSON.stringify(itemHistory));
          updateItemSuggestions();
        }
        
        renderItems();
        document.body.removeChild(editForm);
        showNotification('Ítem actualizado correctamente');
      });
      
      $('#cancelEdit').addEventListener('click', () => {
        document.body.removeChild(editForm);
      });
    }
    if (del !== null){
      const i = Number(del);
      items.splice(i,1);
      renderItems();
      showNotification('Ítem eliminado correctamente');
    }
  });

  // IVA selector por select - MEJORADO
  $('#ivaSelect').addEventListener('change', () => {
    ivaPct = parseFloat($('#ivaSelect').value);
    $('#ivaPctView').textContent = `(${ivaPct}%)`; // Actualizar visualización
    computeTotals(); // Actualizar cálculos inmediatamente
    showNotification(`IVA actualizado a ${ivaPct}%`);
  });

  // Descuento/Bonificación
  $('#applyDesc').addEventListener('click', ()=>{
    descPct = Math.max(0, parseNum($('#descPct').value));
    computeTotals();
    showNotification(`Descuento del ${descPct}% aplicado`);
  });

  // Cálculo de totales - CORREGIDO: El descuento resta del subtotal
  function computeTotals(){
    const subtotal = items.reduce((acc,it)=> acc + it.cant*it.unit, 0);
    const prenda = 0; // fija en 0 por ahora
    const descuento = subtotal * (descPct/100); // descuento (resta)
    const baseIva = subtotal - descuento + prenda; // restamos el descuento
    const iva = baseIva * (ivaPct/100);
    const total = baseIva + iva;

    $('#prendaVal').textContent = fmt(prenda, currentCurrency);
    $('#descVal').textContent = fmt(descuento, currentCurrency);
    $('#ivaVal').textContent = fmt(iva, currentCurrency);
    $('#totalVal').textContent = fmt(total, currentCurrency);
    $('#budgetTotalText').textContent = fmt(total, currentCurrency);
  }

  // Cerrar presupuesto - MEJORADO
  $('#closeBudget').addEventListener('click', () => {
    if (!$('#razon').value.trim()) {
      showNotification('Debes ingresar la razón social del cliente', 'error');
      return;
    }
    
    if (items.length === 0) {
      showNotification('Debes agregar al menos un ítem al presupuesto', 'error');
      return;
    }
    
    if (confirm('¿Está seguro que desea cerrar este presupuesto? Se incrementará el número de presupuesto.')) {
      // Asegurarse de que los totales estén calculados
      computeTotals();
      
      // Guardar datos del presupuesto actual
      const budgetData = {
        budgetNumber: currentBudgetNumber,
        date: new Date().toISOString(),
        currency: currentCurrency,
        clientData: {
          razon: $('#razon').value,
          cuit: $('#cuit').value,
          direccion: $('#direccion').value,
          contacto: $('#contacto').value,
          telefono: $('#telefono').value,
          mail: $('#mail').value
        },
        proposal: {
          desc: $('#descArea').innerHTML,
          diag: $('#diagArea').innerHTML,
          tareas: $('#tareasArea').innerHTML,
          notas: $('#notasArea').innerHTML
        },
        items: items,
        deliveryTerms: $('#deliveryTerms').innerHTML,
        paymentTerms: $('#paymentTerms').innerHTML,
        notes: $('#notes').innerHTML,
        subtotal: parseNum($('#subtotal').textContent),
        discount: parseNum($('#descVal').textContent),
        prenda: parseNum($('#prendaVal').textContent),
        iva: parseNum($('#ivaVal').textContent),
        total: parseNum($('#totalVal').textContent),
        ivaPercentage: ivaPct
      };
      
      // Guardar en localStorage si está disponible
      if (localStorageAvailable) {
        savedBudgets.push(budgetData);
        localStorage.setItem('savedBudgets', JSON.stringify(savedBudgets));
      }
      
      // Incrementar número de presupuesto
      setBudgetId(currentBudgetNumber + 1);
      
      // Limpiar formulario
      clearForm();
      
      showNotification('Presupuesto cerrado exitosamente. Número de presupuesto incrementado.');
    }
  });

  // Exportar a Excel - MEJORADO
  $('#exportExcel').addEventListener('click', () => {
    if (items.length === 0) {
      showNotification('No hay ítems para exportar', 'warning');
      return;
    }
    
    try {
      // Verificar que la librería XLSX esté disponible
      if (typeof XLSX === 'undefined') {
        showNotification('Error: Librería XLSX no disponible. Verifique su conexión a internet.', 'error');
        return;
      }
      
      // Crear un libro de trabajo
      const wb = XLSX.utils.book_new();
      
      // Datos del presupuesto
      const presupuestoData = [
        ['Presupuesto N°', currentBudgetNumber],
        ['Moneda', currentCurrency],
        ['Fecha', $('#fechaEmitida').textContent],
        ['Cliente', $('#razon').value],
        ['CUIT', $('#cuit').value],
        ['Dirección', $('#direccion').value],
        ['Contacto', $('#contacto').value],
        ['Teléfono', $('#telefono').value],
        ['Email', $('#mail').value],
        ['Usuario', $('#userDisplay').textContent],
        [],
        ['Propuesta Técnica'],
        ['Descripción', $('#descArea').innerText],
        ['Diagnóstico', $('#diagArea').innerText],
        ['Tareas', $('#tareasArea').innerText],
        ['Notas', $('#notasArea').innerText],
        [],
        ['Propuesta Económica'],
        ['Cant.', 'Descripción', 'Tipo', `Unitario (${currentCurrency})`, `Subtotal (${currentCurrency})`]
      ];
      
      // Agregar ítems
      items.forEach(item => {
        presupuestoData.push([
          item.cant,
          item.desc,
          item.tipo,
          item.unit.toFixed(2),
          (item.cant * item.unit).toFixed(2)
        ]);
      });
      
      // Agregar totales
      presupuestoData.push(
        [],
        ['Subtotal', '', '', '', $('#subtotal').textContent],
        ['Descuento', '', '', '', $('#descVal').textContent],
        ['Prenda', '', '', '', $('#prendaVal').textContent],
        ['IVA', '', '', '', $('#ivaVal').textContent],
        ['TOTAL', '', '', '', $('#totalVal').textContent]
      );
      
      // Agregar apartados adicionales
      presupuestoData.push(
        [],
        ['Plazos de Entrega'],
        [$('#deliveryTerms').innerText],
        [],
        ['Condición de Pago'],
        [$('#paymentTerms').innerText],
        [],
        ['Notas Adicionales'],
        [$('#notes').innerText]
      );
      
      // Crear hoja de cálculo
      const ws = XLSX.utils.aoa_to_sheet(presupuestoData);
      XLSX.utils.book_append_sheet(wb, ws, "Presupuesto");
      
      // Guardar el archivo
      const blob = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      downloadFile(new Blob([blob]), `Presupuesto_${currentBudgetNumber}_${currentCurrency}.xlsx`);
      showNotification('Presupuesto exportado a Excel correctamente');
    } catch (error) {
      showNotification('Error al exportar a Excel. Intente nuevamente.', 'error');
      console.error('Error exportando Excel:', error);
    }
  });

  // Exportar a PDF - MEJORADO CON IMAGEN
  $('#exportPDF').addEventListener('click', () => {
    if (items.length === 0) {
      showNotification('No hay ítems para exportar', 'warning');
      return;
    }
    
    try {
      // Verificar que las librerías PDF estén disponibles
      if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
        showNotification('Error: Librerías PDF no disponibles. Verifique su conexión a internet.', 'error');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Configuración de fuentes
      doc.setFont('helvetica');
      
      // NUEVO: Agregar imagen institucional al encabezado
      if (logoImage) {
        doc.addImage(logoImage, 'PNG', 15, 10, 50, 20); // (x, y, ancho, alto)
      }
      
      // Función para verificar si necesitamos agregar una nueva página
      function checkPageSpace(yPosition, requiredSpace = 20) {
        const pageHeight = doc.internal.pageSize.height;
        const margin = 20; // Margen inferior
        
        if (yPosition + requiredSpace > pageHeight - margin) {
          doc.addPage();
          return 20; // Nueva posición inicial en la nueva página
        }
        return yPosition;
      }
      
      // Título
      doc.setFontSize(20);
      doc.text('PRESUPUESTO', 105, 45, { align: 'center' }); // Ajustado para dejar espacio para la imagen
      
      // Datos de la empresa
      doc.setFontSize(16);
      doc.setTextColor(14, 98, 176); // Color azul #0e62b0
      doc.text('HIDRÁULICA ENSENADA', 105, 55, { align: 'center' });
      doc.setFontSize(12);
      doc.setTextColor(102, 102, 102); // Color gris #666666
      doc.text('Conexiones Hidráulicas y Neumáticas', 105, 62, { align: 'center' });
      doc.setTextColor(0, 0, 0); // Restaurar color negro
      
      // Datos del presupuesto
      doc.setFontSize(12);
      let yPosition = 75; // Ajustado para dejar espacio después de los datos de la empresa
      
      // Verificar espacio para los datos del presupuesto
      yPosition = checkPageSpace(yPosition, 120); // Espacio necesario para los datos del presupuesto
      
      doc.text(`Presupuesto N°: ${currentBudgetNumber}`, 20, yPosition);
      yPosition += 10;
      doc.text(`Moneda: ${currentCurrency}`, 20, yPosition);
      yPosition += 10;
      doc.text(`Fecha: ${$('#fechaEmitida').textContent}`, 20, yPosition);
      yPosition += 10;
      doc.text(`Cliente: ${$('#razon').value}`, 20, yPosition);
      yPosition += 10;
      doc.text(`CUIT: ${$('#cuit').value}`, 20, yPosition);
      yPosition += 10;
      doc.text(`Dirección: ${$('#direccion').value}`, 20, yPosition);
      yPosition += 10;
      doc.text(`Contacto: ${$('#contacto').value}`, 20, yPosition);
      yPosition += 10;
      doc.text(`Teléfono: ${$('#telefono').value}`, 20, yPosition);
      yPosition += 10;
      doc.text(`Email: ${$('#mail').value}`, 20, yPosition);
      yPosition += 10;
      doc.text(`Usuario: ${$('#userDisplay').textContent}`, 20, yPosition);
      
      // Propuesta técnica
      yPosition += 20;
      yPosition = checkPageSpace(yPosition, 20);
      
      doc.setFontSize(14);
      doc.text('Propuesta Técnica', 20, yPosition);
      yPosition += 10;
      doc.setFontSize(12);
      
      if ($('#descArea').innerText.trim()) {
        yPosition = checkPageSpace(yPosition, 20);
        doc.text('Descripción:', 20, yPosition);
        yPosition += 5;
        const descLines = doc.splitTextToSize($('#descArea').innerText, 170);
        yPosition = checkPageSpace(yPosition, descLines.length * 5);
        doc.text(descLines, 20, yPosition);
        yPosition += descLines.length * 5 + 5;
      }
      
      if ($('#diagArea').innerText.trim()) {
        yPosition = checkPageSpace(yPosition, 20);
        doc.text('Diagnóstico:', 20, yPosition);
        yPosition += 5;
        const diagLines = doc.splitTextToSize($('#diagArea').innerText, 170);
        yPosition = checkPageSpace(yPosition, diagLines.length * 5);
        doc.text(diagLines, 20, yPosition);
        yPosition += diagLines.length * 5 + 5;
      }
      
      if ($('#tareasArea').innerText.trim()) {
        yPosition = checkPageSpace(yPosition, 20);
        doc.text('Tareas:', 20, yPosition);
        yPosition += 5;
        const tareasLines = doc.splitTextToSize($('#tareasArea').innerText, 170);
        yPosition = checkPageSpace(yPosition, tareasLines.length * 5);
        doc.text(tareasLines, 20, yPosition);
        yPosition += tareasLines.length * 5 + 5;
      }
      
      if ($('#notasArea').innerText.trim()) {
        yPosition = checkPageSpace(yPosition, 20);
        doc.text('Notas:', 20, yPosition);
        yPosition += 5;
        const notasLines = doc.splitTextToSize($('#notasArea').innerText, 170);
        yPosition = checkPageSpace(yPosition, notasLines.length * 5);
        doc.text(notasLines, 20, yPosition);
        yPosition += notasLines.length * 5 + 5;
      }
      
      // Propuesta económica
      yPosition += 10;
      yPosition = checkPageSpace(yPosition, 20);
      
      doc.setFontSize(14);
      doc.text('Propuesta Económica', 20, yPosition);
      yPosition += 10;
      
      // Tabla de ítems
      const tableData = [];
      items.forEach(item => {
        tableData.push([
          item.cant,
          item.desc,
          item.tipo,
          fmt(item.unit, currentCurrency),
          fmt(item.cant * item.unit, currentCurrency)
        ]);
      });
      
      if (typeof doc.autoTable !== 'undefined') {
        // autoTable maneja automáticamente el salto de página
        doc.autoTable({
          head: [['Cant.', 'Descripción', 'Tipo', `Unitario (${currentCurrency})`, `Subtotal (${currentCurrency})`]],
          body: tableData,
          startY: yPosition,
          theme: 'grid',
          styles: { fontSize: 10 },
          headStyles: { fillColor: [240, 240, 240] },
          margin: { top: 10 }
        });
        
        yPosition = doc.lastAutoTable.finalY + 10;
      } else {
        // Si autoTable no está disponible, crear tabla manualmente
        yPosition = checkPageSpace(yPosition, 20);
        doc.text('Cant.', 20, yPosition);
        doc.text('Descripción', 40, yPosition);
        doc.text('Tipo', 120, yPosition);
        doc.text(`Unitario (${currentCurrency})`, 150, yPosition);
        doc.text(`Subtotal (${currentCurrency})`, 180, yPosition);
        yPosition += 10;
        
        tableData.forEach(row => {
          yPosition = checkPageSpace(yPosition, 10);
          doc.text(row[0].toString(), 20, yPosition);
          doc.text(row[1], 40, yPosition);
          doc.text(row[2], 120, yPosition);
          doc.text(row[3], 150, yPosition);
          doc.text(row[4], 180, yPosition);
          yPosition += 10;
        });
      }
      
      // Totales
      yPosition = checkPageSpace(yPosition, 60);
      doc.text(`Subtotal: ${$('#subtotal').textContent}`, 140, yPosition);
      yPosition += 10;
      doc.text(`Descuento: ${$('#descVal').textContent}`, 140, yPosition);
      yPosition += 10;
      doc.text(`Prenda: ${$('#prendaVal').textContent}`, 140, yPosition);
      yPosition += 10;
      doc.text(`IVA: ${$('#ivaVal').textContent}`, 140, yPosition);
      yPosition += 10;
      doc.setFontSize(14);
      doc.text(`TOTAL: ${$('#totalVal').textContent}`, 140, yPosition);
      doc.setFontSize(12);
      
      // Apartados adicionales
      yPosition += 20;
      yPosition = checkPageSpace(yPosition, 20);
      
      if ($('#deliveryTerms').innerText.trim()) {
        doc.text('Plazos de Entrega:', 20, yPosition);
        yPosition += 5;
        const deliveryLines = doc.splitTextToSize($('#deliveryTerms').innerText, 170);
        yPosition = checkPageSpace(yPosition, deliveryLines.length * 5);
        doc.text(deliveryLines, 20, yPosition);
        yPosition += deliveryLines.length * 5 + 5;
      }
      
      if ($('#paymentTerms').innerText.trim()) {
        yPosition = checkPageSpace(yPosition, 20);
        doc.text('Condición de Pago:', 20, yPosition);
        yPosition += 5;
        const paymentLines = doc.splitTextToSize($('#paymentTerms').innerText, 170);
        yPosition = checkPageSpace(yPosition, paymentLines.length * 5);
        doc.text(paymentLines, 20, yPosition);
        yPosition += paymentLines.length * 5 + 5;
      }
      
      if ($('#notes').innerText.trim()) {
        yPosition = checkPageSpace(yPosition, 20);
        doc.text('Notas Adicionales:', 20, yPosition);
        yPosition += 5;
        const notesLines = doc.splitTextToSize($('#notes').innerText, 170);
        yPosition = checkPageSpace(yPosition, notesLines.length * 5);
        doc.text(notesLines, 20, yPosition);
        yPosition += notesLines.length * 5 + 5;
      }
      
      // Guardar el PDF
      doc.save(`Presupuesto_${currentBudgetNumber}_${currentCurrency}.pdf`);
      showNotification('Presupuesto exportado a PDF correctamente');
    } catch (error) {
      showNotification('Error al exportar a PDF. Intente nuevamente.', 'error');
      console.error('Error exportando PDF:', error);
    }
  });

  // Compartir por WhatsApp - MEJORADO
  $('#shareWhatsApp').addEventListener('click', () => {
    try {
      const total = $('#totalVal').textContent;
      const client = $('#razon').value || 'Cliente';
      const message = `Presupuesto N°${String(currentBudgetNumber).padStart(3,'0')} (${currentCurrency}) para ${client}. Total: ${total}.`;
      
      // Método más compatible
      const whatsappWebUrl = `https://web.whatsapp.com/send?text=${encodeURIComponent(message)}`;
      const whatsappAppUrl = `whatsapp://send?text=${encodeURIComponent(message)}`;
      
      // Intentar abrir la app móvil primero
      window.open(whatsappAppUrl, '_blank');
      
      // Si no funciona, mostrar un enlace
      setTimeout(() => {
        const link = document.createElement('a');
        link.href = whatsappWebUrl;
        link.target = '_blank';
        link.textContent = 'Abrir WhatsApp Web';
        link.style.display = 'block';
        link.style.marginTop = '10px';
        link.style.padding = '10px';
        link.style.backgroundColor = '#25D366';
        link.style.color = 'white';
        link.style.textAlign = 'center';
        link.style.borderRadius = '5px';
        link.style.textDecoration = 'none';
        
        // Insertar después del botón
        $('#shareWhatsApp').parentNode.insertBefore(link, $('#shareWhatsApp').nextSibling);
        
        // Eliminar el enlace después de 10 segundos
        setTimeout(() => {
          if (link.parentNode) {
            link.parentNode.removeChild(link);
          }
        }, 10000);
      }, 500);
      
      showNotification('Enlace de WhatsApp generado');
    } catch (error) {
      showNotification('Error al generar enlace de WhatsApp', 'error');
      console.error('Error compartiendo WhatsApp:', error);
    }
  });

  // Ver presupuestos guardados - MEJORADO
  $('#viewBudgets').addEventListener('click', () => {
    try {
      const modal = $('#budgetsModal');
      const budgetsList = $('#budgetsList');
      
      budgetsList.innerHTML = '';
      
      if (!localStorageAvailable || savedBudgets.length === 0) {
        budgetsList.innerHTML = '<p>No hay presupuestos guardados</p>';
      } else {
        savedBudgets.forEach((budget, index) => {
          const budgetItem = document.createElement('div');
          budgetItem.className = 'card';
          budgetItem.style.marginBottom = '10px';
          
          // Asegurarse de que el total sea un número válido
          const totalValue = typeof budget.total === 'number' ? budget.total : 0;
          
          budgetItem.innerHTML = `
            <h3>Presupuesto N°${budget.budgetNumber} (${budget.currency}) - ${new Date(budget.date).toLocaleDateString('es-AR')}</h3>
            <p><strong>Cliente:</strong> ${budget.clientData.razon}</p>
            <p><strong>Total:</strong> ${fmt(totalValue, budget.currency)}</p>
            <div class="actions">
              <button class="btn" data-view-budget="${index}">Ver</button>
              <button class="btn btn-danger" data-delete-budget="${index}">Eliminar</button>
            </div>
          `;
          budgetsList.appendChild(budgetItem);
        });
        
        // Agregar eventos a los botones
        $$('[data-view-budget]').forEach(btn => {
          btn.addEventListener('click', () => {
            const index = btn.getAttribute('data-view-budget');
            loadBudget(index);
            modal.style.display = 'none';
          });
        });
        
        $$('[data-delete-budget]').forEach(btn => {
          btn.addEventListener('click', () => {
            const index = btn.getAttribute('data-delete-budget');
            if (confirm('¿Está seguro que desea eliminar este presupuesto?')) {
              savedBudgets.splice(index, 1);
              if (localStorageAvailable) {
                localStorage.setItem('savedBudgets', JSON.stringify(savedBudgets));
              }
              $('#viewBudgets').click(); // Recargar la lista
              showNotification('Presupuesto eliminado correctamente');
            }
          });
        });
      }
      
      modal.style.display = 'block';
    } catch (error) {
      showNotification('Error al cargar presupuestos guardados', 'error');
      console.error('Error cargando presupuestos:', error);
    }
  });

  // Cerrar modal
  $('#closeModal').addEventListener('click', () => {
    $('#budgetsModal').style.display = 'none';
  });

  // Cargar presupuesto guardado - MEJORADO
  function loadBudget(index) {
    try {
      const budget = savedBudgets[index];
      
      // Cargar moneda
      currentCurrency = budget.currency;
      $('#currencySelect').value = currentCurrency;
      
      // Cargar datos del cliente
      $('#razon').value = budget.clientData.razon;
      $('#cuit').value = budget.clientData.cuit;
      $('#direccion').value = budget.clientData.direccion;
      $('#contacto').value = budget.clientData.contacto;
      $('#telefono').value = budget.clientData.telefono;
      $('#mail').value = budget.clientData.mail;
      
      // Cargar propuesta técnica
      $('#descArea').innerHTML = budget.proposal.desc;
      $('#diagArea').innerHTML = budget.proposal.diag;
      $('#tareasArea').innerHTML = budget.proposal.tareas;
      $('#notasArea').innerHTML = budget.proposal.notas;
      
      // Cargar ítems
      items = budget.items;
      renderItems();
      
      // Cargar apartados adicionales
      $('#deliveryTerms').innerHTML = budget.deliveryTerms;
      $('#paymentTerms').innerHTML = budget.paymentTerms;
      $('#notes').innerHTML = budget.notes;
      
      // Cargar valores económicos
      descPct = (budget.discount / budget.subtotal) * 100;
      $('#descPct').value = descPct;
      ivaPct = budget.ivaPercentage;
      $('#ivaSelect').value = ivaPct;
      $('#ivaPctView').textContent = `(${ivaPct}%)`;
      
      // Actualizar número de presupuesto
      setBudgetId(budget.budgetNumber);
      
      showNotification('Presupuesto cargado correctamente');
    } catch (error) {
      showNotification('Error al cargar presupuesto', 'error');
      console.error('Error cargando presupuesto:', error);
    }
  }

  // Limpiar formulario - MEJORADO
  function clearForm() {
    // Limpiar datos del cliente
    $('#razon').value = '';
    $('#cuit').value = '';
    $('#direccion').value = '';
    $('#contacto').value = '';
    $('#telefono').value = '';
    $('#mail').value = '';
    
    // Limpiar propuesta técnica
    $('#descArea').innerHTML = '';
    $('#diagArea').innerHTML = '';
    $('#tareasArea').innerHTML = '';
    $('#notasArea').innerHTML = '';
    
    // Limpiar items
    items = [];
    renderItems();
    
    // Limpiar nuevos apartados
    $('#deliveryTerms').innerHTML = '';
    $('#paymentTerms').innerHTML = '';
    $('#notes').innerHTML = '';
    
    // Resetear valores económicos
    descPct = 0;
    $('#descPct').value = '';
    ivaPct = 21;
    $('#ivaSelect').value = ivaPct;
    $('#ivaPctView').textContent = `(${ivaPct}%)`;
    
    computeTotals();
  }

  // NUEVO: Evento para cargar imagen institucional
  $('#logoInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(event) {
        logoImage = event.target.result;
        showNotification('Imagen institucional cargada correctamente');
      };
      reader.readAsDataURL(file);
    }
  });

  // Init
  (function init(){
    setFechaEmitida();
    updateItemSuggestions();
    renderItems(); // inicia vacío
  })();
</script>

<!-- Librerías para exportación -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
</body>
<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAlcpxFf7HiIFX34QMABkBIGyz_i7N0lt8",
    authDomain: "base-a2f85.firebaseapp.com",
    projectId: "base-a2f85",
    storageBucket: "base-a2f85.firebasestorage.app",
    messagingSenderId: "626261131485",
    appId: "1:626261131485:web:04db4e232f9f6055131b34"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
</script>
</html>